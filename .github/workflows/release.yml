name: Release public EAR Tool [template]

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Ensure tag commit is on a stable branch (v5, v6, v7)
        run: |
          if [[ "${GITHUB_REF}" != refs/tags/v* ]]; then
            echo "::error::This workflow must be triggered by a tag starting with 'v'."
            exit 1
          fi

          git fetch origin --prune
          COMMIT_SHA=$(git rev-parse HEAD)

          allowed=false
          for branch in v5 v6 v7; do
            if git ls-remote --exit-code --heads origin "$branch" >/dev/null 2>&1; then
              if git branch -r --contains "$COMMIT_SHA" | grep -q "origin/${branch}$"; then
                echo "âœ… Commit is contained in ${branch}"
                allowed=true
              fi
            fi
          done

          if [ "$allowed" != "true" ]; then
            echo "::error::Tag is not on any stable branch (v5, v6, v7). Aborting release."
            exit 1
          fi

      - name: Check tag version matches pyproject.toml
        run: |
          TAG="${GITHUB_REF##*/}"
          VERSION="${TAG#v}"

          python -m pip install --upgrade pip tomli

          PYPROJECT_VERSION=$(python - << 'EOF'
          import tomli
          from pathlib import Path

          data = tomli.loads(Path("pyproject.toml").read_text(encoding="utf-8"))
          print(data["project"]["version"])
          EOF
          )

          echo "Tag version:        $VERSION"
          echo "pyproject version:  $PYPROJECT_VERSION"

          if [ "$VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "::error::Tag version ($VERSION) does not match pyproject.toml version ($PYPROJECT_VERSION)"
            exit 1
          fi

      - name: Install project and test dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install ".[test]" || python -m pip install .

      - name: Run tests
        run: |
          if ! command -v pytest >/dev/null 2>&1; then
            python -m pip install pytest
          fi
          set +e
          pytest
          status=$?
          if [ "$status" -eq 5 ]; then
            echo "No tests collected; continuing."
            exit 0
          fi
          exit "$status"

      - name: Install build tools
        run: python -m pip install build

      - name: Build sdist and wheel
        run: python -m build

      - name: Publish to public PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}

      - name: Create GitHub Release and upload artifacts
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.whl
            dist/*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
